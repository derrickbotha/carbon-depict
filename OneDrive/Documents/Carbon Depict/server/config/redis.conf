# Redis Configuration for Carbon Depict
# Production-ready configuration with security and performance optimizations

# ==============================================
# NETWORK
# ==============================================
bind 0.0.0.0
protected-mode yes
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ==============================================
# SECURITY
# ==============================================
# Require password (set in docker-compose.yml or .env)
# requirepass your-strong-password-here

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG-CARBONDEPICT"

# ==============================================
# MEMORY MANAGEMENT
# ==============================================
# Maximum memory (adjust based on available RAM)
maxmemory 256mb

# Eviction policy: remove least recently used keys when max memory reached
maxmemory-policy allkeys-lru

# Number of samples for LRU algorithm
maxmemory-samples 5

# ==============================================
# PERSISTENCE
# ==============================================
# RDB Snapshots
save 900 1      # Save if at least 1 key changed in 900 seconds (15 min)
save 300 10     # Save if at least 10 keys changed in 300 seconds (5 min)
save 60 10000   # Save if at least 10000 keys changed in 60 seconds

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# AOF (Append Only File) - Disabled for better performance
# Enable in production if you need better durability
appendonly no
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ==============================================
# SLOW LOG
# ==============================================
slowlog-log-slower-than 10000  # Log queries slower than 10ms
slowlog-max-len 128

# ==============================================
# ADVANCED CONFIG
# ==============================================
# Latency monitoring
latency-monitor-threshold 100

# Number of databases
databases 16

# Close connection after client idle for N seconds (0 to disable)
timeout 300

# Disable client output buffer limits for normal clients
client-output-buffer-limit normal 0 0 0

# Pub/Sub clients
client-output-buffer-limit pubsub 32mb 8mb 60

# ==============================================
# REPLICATION (for production clusters)
# ==============================================
# If this is a replica, uncomment and configure:
# replicaof <master-ip> <master-port>
# masterauth <master-password>

# ==============================================
# LOGGING
# ==============================================
loglevel notice
logfile ""

# ==============================================
# PERFORMANCE
# ==============================================
# Disable transparent huge pages warning
disable-thp yes

# Active defragmentation
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# ==============================================
# PRODUCTION NOTES
# ==============================================
# 1. Set a strong password via requirepass
# 2. Adjust maxmemory based on your server
# 3. Enable AOF if durability is critical
# 4. Monitor with Redis Commander or RedisInsight
# 5. Set up replication for high availability
# 6. Use Redis Sentinel or Cluster for production
# ==============================================
